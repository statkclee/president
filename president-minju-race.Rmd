---
layout: page
title: "대통령 선거 2022년"
subtitle: "민주당 경선"
author:
- name: "이광춘"
  affiliation: "[Tidyverse Korea](https://www.facebook.com/groups/tidyverse/)"
date: "`r Sys.Date()`"
tags: ["여론조사", "제20대", "대통령 선거", "후진국", "중진국", "선진국", "선거일정", "경선", "주요", "민주당 경선"]
output:
  html_document: 
    include:
      after_body: footer.html
      before_body: header.html
    toc: yes
    toc_depth: 2
    toc_float: true
    highlight: tango
    code_folding: hide
    number_section: true
    self_contained: true
bibliography: bibliography_presid.bib
csl: biomed-central.csl
urlcolor: blue
linkcolor: blue
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE,
                      comment="", digits = 3, tidy = FALSE, prompt = FALSE, fig.align = 'center')
library(tidyverse)
library(rvest)
library(lubridate)
```

![](fig/hwp2table.png)

# 민주당 경선 데이터 {#minju-race}

[민주당 보도자료](https://theminjoo.kr/board/lists/presskit)를 통해서 제 20 대 대선 후보자 선출을 위한 민주당 경선 데이터를 얻을 수 있다.

- [210904_대전충남제20대_대선_후보자_선출_위한_결과_보도자료](data/minju_race/210904_대전충남제20대_대선_후보자_선출_위한_결과_보도자료.pdf)
- [210905_(세종충북)_제20대_대선_후보자_선출_위한_결과_보도자료](data/minju_race/210905_(세종충북)_제20대_대선_후보자_선출_위한_결과_보도자료_fn.pdf)
- [210911_대구경북_제20대_대선_후보자_선출_위한_결과_보도자료](data/minju_race/210911_대구경북_제20대_대선_후보자_선출_위한_결과_보도자료.pdf)
- [210912_제20대_대선후보자_선출_위한_순회경선_결과_보도자료(강원)](data/minju_race/210912_제20대_대선후보자_선출_위한_순회경선_결과_보도자료(강원)_fn.pdf)

## HWP &rarr; PDF {#minju-race-hwp}

먼저 HWP 파일을 PDF로 변환시킨 후에 `tabulizer`에서 표를 추출한다.

```{r minju-data, eval = FALSE}
library(tidyverse)
library(tabulizer)

# locate_areas(file = "data/minju_race/210904.pdf", pages = 1)
# 선거인단
# Listening on http://127.0.0.1:4065
# [[1]]
#       top      left    bottom     right 
# 207.64360  58.57953 332.75103 538.15807 
# 경선결과
# [[1]]
#       top      left    bottom     right 
# 372.71591  55.10433 721.97417 538.15807 

# 대전충남_선거인단 <- extract_tables("data/minju_race/210904_대전충남제20대_대선_후보자_선출_위한_결과_보도자료.pdf",
대전충남_선거인단 <- extract_tables("data/minju_race/210904_대전충남제20대_대선_후보자_선출_위한_결과_보도자료.pdf",
                             pages = 1,
                             encoding = "UTF-8",
                             output = "data.frame",
                             method = "stream",
                             guess = TRUE,
                             area = list(c(207.64360, 58.57953, 332.75103, 538.15807)))

대전충남_선거결과 <- extract_tables("data/minju_race/210904_대전충남제20대_대선_후보자_선출_위한_결과_보도자료.pdf",
                             pages = 1,
                             encoding = "UTF-8",
                             method = "stream",
                             output = "data.frame",
                             guess = TRUE,
                             area = list(c(372.71591, 55.10433, 721.97417, 538.15807)))

```

앞서 해당 영역에서 추출한 표를 바탕으로 후처리 작업을 해서 데이터 분석과 시각화가 가능한 형태로 변환시킨다.

```{r 대전충남, eval = FALSE}

대전충남_tbl <- `대전충남_선거결과` %>% 
  .[[1]] %>% 
  janitor::clean_names(ascii=FALSE) %>% 
  set_names(c("기호", "후보자명", "전국대의원", "권리당원", 
"x", "유선전화", "합계")) %>% 
  select(-기호, -x, -합계) %>% 
  filter(후보자명 != "") %>% 
  pivot_longer(-후보자명, names_to = "구분", values_to = "득표") %>% 
  mutate(후보자명 = str_remove_all(후보자명, "\\s"))  %>% 
  mutate(득표 = parse_number(득표))
  
대전충남_tbl

```

## HWP &rarr; DOCX [^hwp2docx] {#minju-race-hwp-docx}

[^hwp2docx]: [한글문서파일 워드로 변환하기](https://blog.naver.com/PostView.nhn?isHttpsRedirect=true&blogId=jooyonas&logNo=221537785840&parentCategoryNo=35&categoryNo=&viewDate=&isShowPopularPosts=true&from=search)

HWP 파일에서 표를 추출하는 방식으로 [Microsoft Word를 위한 아래아한글 문서 변환 도구](https://www.microsoft.com/ko-kr/download/details.aspx?id=36772)를 PC에 설치한 다음 `C:\Program Files\Microsoft Office\Office15` 디렉토리 `BATHCHWPCONV.EXE` 파일을 실행시켜 워드 파일을 얻는 것이다.

![](fig/hwp2docx.jpg)

[`docxtractr`](https://cran.r-project.org/web/packages/docxtractr/index.html) 팩키지를 사용해서 워드파일에서 표를 추출한다.

### 대전 충청남도 {#minju-race-hwp-docx-충남}

```{r minju-data-docx}
library(docxtractr)
library(tidyverse)

choongnam_doc <- docxtractr::read_docx(path = "data/minju_race/210904.docx")

choongnam_vote_raw <- docx_extract_tbl(choongnam_doc, 2, header = FALSE)

choongnam_vote_tbl <- choongnam_vote_raw %>% 
  janitor::clean_names(ascii = FALSE) %>% 
  set_names(c("구분", "선거인수")) %>% 
  filter( str_detect(구분, "투표자|기권자|무효표")) %>% 
  mutate(선거인수 = parse_number(선거인수))

choongnam_vote_tbl %>% 
  write_rds("data/minju_race/choongnam_vote_tbl.rds")

## 대전 충남 선거결과 -----------------------------

choongnam_raw <- docx_extract_tbl(choongnam_doc, 3)

choongnam_tbl <- choongnam_raw %>% 
  janitor::clean_names(ascii = FALSE) %>% 
  set_names(c("기호", "후보자명", "전국대의원", "권리당원", "유선전화", "합계")) %>% 
  select(-기호, -합계) %>% 
  filter(후보자명 != "") %>% 
  pivot_longer(-후보자명, names_to = "구분", values_to = "득표") %>% 
  mutate(후보자명 = str_remove_all(후보자명, "\\s"))  %>% 
  mutate(득표 = parse_number(득표))

choongnam_tbl %>% 
  write_rds("data/minju_race/choongnam_tbl.rds")
```



### 세종 충청북도 {#minju-race-hwp-docx-충북}


```{r minju-충북}
choongbook_doc <- read_docx("data/minju_race/210905.docx")

choongbook_vote_raw <- docx_extract_tbl(choongbook_doc, 4, header = FALSE)

choongbook_vote_tbl <- choongbook_vote_raw %>% 
  janitor::clean_names(ascii = FALSE) %>% 
  set_names(c("구분", "선거인수", "x")) %>% 
  select(-x) %>% 
  filter( str_detect(구분, "투표자|기권자|무효표")) %>% 
  mutate(선거인수 = parse_number(선거인수)) 

choongbook_vote_tbl %>% 
  write_rds("data/minju_race/choongbook_vote_tbl.rds")

## 세종 충북 선거결과 -----------------------------

choongbook_raw <- docx_extract_tbl(choongbook_doc, 5)

choongbook_tbl <- choongbook_raw %>% 
  janitor::clean_names(ascii = FALSE) %>% 
  set_names(c("기호", "후보자명", "전국대의원", "권리당원", "유선전화", "합계")) %>% 
  select(-기호, -합계) %>% 
  filter(후보자명 != "") %>% 
  pivot_longer(-후보자명, names_to = "구분", values_to = "득표") %>% 
  mutate(후보자명 = str_remove_all(후보자명, "\\s"))  %>% 
  mutate(득표 = parse_number(득표))

choongbook_tbl %>% 
  write_rds("data/minju_race/choongbook_tbl.rds")
```


### 대구 경북 {#minju-race-hwp-docx-경북}


```{r minju-경북}
kyungbook_doc <- read_docx("data/minju_race/210911.docx")

kyungbook_vote_raw <- docx_extract_tbl(kyungbook_doc, 4, header = FALSE)

kyungbook_vote_tbl <- kyungbook_vote_raw %>% 
  janitor::clean_names(ascii = FALSE) %>% 
  set_names(c("구분", "선거인수", "x")) %>% 
  select(-x) %>% 
  filter( str_detect(구분, "투표자|기권자|무효표")) %>% 
  mutate(선거인수 = parse_number(선거인수)) 

kyungbook_vote_tbl %>% 
  write_rds("data/minju_race/kyungbook_vote_tbl.rds")

## 대구 경북 선거결과 -----------------------------

kyungbook_raw <- docx_extract_tbl(kyungbook_doc, 5)

kyungbook_tbl <- kyungbook_raw %>% 
  janitor::clean_names(ascii = FALSE) %>% 
  set_names(c("기호", "후보자명", "전국대의원", "권리당원", "유선전화", "합계")) %>% 
  select(-기호, -합계) %>% 
  filter(후보자명 != "") %>% 
  pivot_longer(-후보자명, names_to = "구분", values_to = "득표") %>% 
  mutate(후보자명 = str_remove_all(후보자명, "\\s"))  %>% 
  mutate(득표 = parse_number(득표))

kyungbook_tbl %>% 
  write_rds("data/minju_race/kyungbook_tbl.rds")
```


### 강원 {#minju-race-hwp-docx-강원}


```{r minju-강원}
kangwon_doc <- read_docx("data/minju_race/210912.docx")

kangwon_vote_raw <- docx_extract_tbl(kangwon_doc, 4, header = FALSE)

kangwon_vote_tbl <- kangwon_vote_raw %>% 
  janitor::clean_names(ascii = FALSE) %>% 
  set_names(c("구분", "선거인수", "x")) %>% 
  select(-x) %>% 
  filter( str_detect(구분, "투표자|기권자|무효표")) %>% 
  mutate(선거인수 = parse_number(선거인수)) 

kangwon_vote_tbl %>% 
  write_rds("data/minju_race/kangwon_vote_tbl.rds")

## 대구 경북 선거결과 -----------------------------

kangwon_raw <- docx_extract_tbl(kangwon_doc, 5, preserve=FALSE, trim = FALSE)



kangwon_tbl <- kangwon_raw %>% 
  janitor::clean_names(ascii = FALSE) %>% 
  set_names(c("기호", "후보자명", "전국대의원", "권리당원", "유선전화", "합계")) %>% 
  select(-기호, -합계) %>% 
  filter(후보자명 != "") %>% 
  pivot_longer(-후보자명, names_to = "구분", values_to = "득표") %>% 
  mutate(후보자명 = str_remove_all(후보자명, "\\s"))  %>% 
  mutate(득표 = parse_number(득표))

kangwon_tbl %>% 
  write_rds("data/minju_race/kangwon_tbl.rds")
```


# 선거인단 {#minju-race-hwp-docx-table}


```{r 선거인단}
library(tidyverse)
library(reactable)

kangwon_vote_raw <- read_rds("data/minju_race/kangwon_vote_tbl.rds") 
choongbook_vote_raw <- read_rds("data/minju_race/choongbook_vote_tbl.rds")
choongnam_vote_raw <- read_rds("data/minju_race/choongnam_vote_tbl.rds")
kyungbook_vote_raw <- read_rds("data/minju_race/kyungbook_vote_tbl.rds")

kangwon_vote_tbl <- kangwon_vote_raw %>% 
  pivot_wider(names_from = "구분", values_from = "선거인수") %>% 
  mutate(시도 = "강원") %>% 
  select(시도, everything()) %>% 
  janitor::clean_names(ascii = FALSE)  %>% 
  set_names(c("시도", "투표자_수", "기권자_수", "무효표_수"))

preprocess_vote <- function(vote_tbl, sido) {
  
  vote_tbl %>% 
    pivot_wider(names_from = "구분", values_from = "선거인수") %>% 
    mutate(시도 = sido) %>% 
    select(시도, everything()) %>% 
    janitor::clean_names(ascii = FALSE)  %>% 
  set_names(c("시도", "투표자_수", "기권자_수", "무효표_수"))
  
}

강원_투표 <- preprocess_vote(kangwon_vote_raw, "강원")
경북_투표 <- preprocess_vote(kyungbook_vote_raw, "대구경북")
충남_투표 <- preprocess_vote(choongnam_vote_raw, "대전충남")
충북_투표 <- preprocess_vote(choongbook_vote_raw, "세종충북")

민주_투표 <- bind_rows(강원_투표, 경북_투표) %>% 
  bind_rows(충남_투표) %>% 
  bind_rows(충북_투표)

민주_투표 %>% 
  mutate(선거인수 = `투표자_수` + `기권자_수`,
         투표율   = `투표자_수` / `선거인수`) %>% 
  reactable::reactable(columns = list(
    `투표자_수` = colDef(format = colFormat(separators = TRUE, digits = 0)),
    `기권자_수` = colDef(format = colFormat(separators = TRUE, digits = 0)),
    `선거인수` = colDef(format = colFormat(separators = TRUE, digits = 0)),
    `투표율` = colDef(format = colFormat(percent = TRUE, digits = 1)))
  )
```



# 경선 결과 {#minju-race-hwp-docx-경선결과}


```{r 경선결과}

kangwon_tbl <- read_rds("data/minju_race/kangwon_tbl.rds") %>% 
  mutate(시도 = "강원")
choongbook_rds <- read_rds("data/minju_race/choongbook_tbl.rds") %>% 
  mutate(시도 = "충북세종")
choongnam_tbl <- read_rds("data/minju_race/choongnam_tbl.rds") %>% 
  mutate(시도 = "충남대전")
kyungbook_tbl <- read_rds("data/minju_race/kyungbook_tbl.rds") %>% 
  mutate(시도 = "경북대구")

sofar_tbl <- bind_rows(kangwon_tbl, choongbook_rds) %>% 
  bind_rows(choongnam_tbl) %>% 
  bind_rows(kyungbook_tbl)

sofar_tbl %>% 
  group_by(후보자명) %>% 
  summarise(누적득표 = sum(득표)) %>% 
  ungroup() %>% 
  arrange(-누적득표) %>% 
  mutate(득표율 = 누적득표  / sum(누적득표)) %>% 
  reactable::reactable(columns = list(
    `누적득표` = colDef(format = colFormat(separators = TRUE, digits = 0)),
    `득표율` = colDef(format = colFormat(percent = TRUE, digits = 1)))
  )  

```

